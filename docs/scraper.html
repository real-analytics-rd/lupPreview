---

title: The Guardian Scraper


keywords: fastai
sidebar: home_sidebar

summary: "Scraping Premier League Previews from the Guardian."
description: "Scraping Premier League Previews from the Guardian."
nb_path: "00_scraper.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_scraper.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To reach the aim of our project, we have begun the first task, which is to collect football experts' comments and data from English Premier League matches.
<br>For this task, we will use match previews from "The Guardian." It goes back far enough, from 2009 to today, to allow us to integrate deep neural networks.
<br>Indeed, "The Guardian's" football experts publish previews every week, usually two or three days before the matches.
<br>In this regard, we began by creating a data extraction tool that will allow us to extract this information on a regular basis.
<br>The information to be extracted is as follows:</p>
<ul>
<li>The names of the competing teams.</li>
<li>The date of the game</li>
<li>The identity of the referee</li>
<li>The stadium's name</li>
<li>Sports odds that will be converted to decimal format</li>
<li>The football expert's text</li>
<li>The text's author.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="A-preliminary-examination-of-the-Guardian's-website">A preliminary examination of the Guardian's website<a class="anchor-link" href="#A-preliminary-examination-of-the-Guardian's-website"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div style="font-size: 200px">

<table>
<thead><tr>
<th>Issues</th>
<th>Solutions</th>
</tr>
</thead>
<tbody>
<tr>
<td>4 possible formats for previews(old format, new format,Cup's format and a particular format)</td>
<td>Select the appropriate html tags</td>
</tr>
<tr>
<td>Preview titles are not the same ( we can find Squad Sheets or match preview)</td>
<td>Pick only the names of the teams and eliminate the rest</td>
</tr>
<tr>
<td>The date of the match is not always available</td>
<td>Pick the preview date</td>
</tr>
<tr>
<td>The order of the elements and labels are not the same</td>
<td>Using regex patterns to get information</td>
</tr>
<tr>
<td>Missing values for betting odds</td>
<td>We treat the general case separately and we set up specific regex patterns for these particular cases</td>
</tr>
<tr>
<td>Odds format is different</td>
<td>We treat the general case separately and we set up specific regex patterns for these particular cases</td>
</tr>
<tr>
<td>We can find non-numeric values for Odds like (Evens,evens,Eve,odds-on)</td>
<td>Replace evens by 1-1</td>
</tr>
<tr>
<td>There are some previews that don't have author and text</td>
<td>For previews that have no text, we put None (not available)</td>
</tr>
<tr>
<td>The existence of previews for the FA CUP,Carabao Cup,Champions league,World Cup</td>
<td>Filter previews by checking if the match exists in "Opta" database, and pick only Premier League match</td>
</tr>
<tr>
<td>We are not sure if the names of the teams are the same as the ones in Opta</td>
<td>Set up a dictionary or check manually to map teams to their IDs</td>
</tr>
<tr>
<td>When we send many requests, the guardian server blocks your IP address, which is interpreted as a DDOS attack</td>
<td>Do a sleep of a random x seconds between requests or change IP address and work with rotating proxy</td>
</tr>
</tbody>
</table>
<p>&lt;/div &gt;</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Import-Libraries-and-Modules">Import Libraries and Modules<a class="anchor-link" href="#Import-Libraries-and-Modules"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ScrapingTheGuardian-Class">ScrapingTheGuardian Class<a class="anchor-link" href="#ScrapingTheGuardian-Class"> </a></h3><h5 id="This-class-represents-a-scraper-from-the-&quot;Guardian&quot;-website-and-has-4-functions:">This class represents a scraper from the "Guardian" website and has 4 functions:<a class="anchor-link" href="#This-class-represents-a-scraper-from-the-&quot;Guardian&quot;-website-and-has-4-functions:"> </a></h5><p>1- <b> calculate_betting_odds </b> returns decimal odds.</p>
<p>&emsp;In this section, we will calculate the odds derived from the football preview.
<br>&emsp;Considering the following example:
<br>&emsp;&emsp; ["9-20","29-5","6-5"] 
<br>&emsp;&emsp;We calculate each sport's rating separately using the following formula:
<br>&emsp;&emsp;&emsp; home = (9/20) + 1 
<br>&emsp;&emsp;&emsp; away = (29/5) + 1
<br>&emsp;&emsp;&emsp; draw = (6/5) + 1
<br>&emsp;If we were successful in obtaining decimal odds, they will be returned in a Python dictionary.<br>&emsp;Otherwise, the values will be None (Not available).</p>
<p>2- <b> extract_preview_items </b>returns the entire contents of a football preview.</p>
<p>&emsp;In this section, we will call the functions defined in the PageExtractor class and return a Python dictionary containing all of this information.
<br>&emsp;But first, we use the <b>calculate_betting_odds</b> function to calculate the sports odds for the home team's victory, the away team's victory, and a draw.</p>
<p>"game Id","home team","away team","text","author","venue","referee","odds","odds home team","odds away team","odds draw", "preview date","game Date","preview_link" are the returned values.</p>
<p>3- <b> extract_previews </b> returns the information of all extracted previews.</p>
<p>&emsp;We retrieve all previews for a given page and go through them one by one, taking the link and getting its data using the "Guardian Api."
<br>&emsp;If the "Guardian Api" does not work, we will resort to the traditional process of html parsing. 
<br>&emsp;For each preview in the data extracted from the Guardian, we will look for the id of the home team and the away team and match it with the <b>opta.fixture</b><br>&emsp;database to get the gameID and gameDate and finally we save it in a MongoDb collection.
<br>&emsp;If the game exists, we will proceed with the data extraction.
The previous function, <b>extract_preview_items</b>, will be called here to extract information from <br>&emsp;each 
preview, which will then be stored in the list "all previews."
<br>&emsp;However, we will only extract previews that do not already exist in the database.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ScrapingTheGuardian" class="doc_header"><code>class</code> <code>ScrapingTheGuardian</code><a href="https://github.com/MeherKharbachi/guardian_scraper/tree/master/guardian_scraper/scraper.py#L23" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ScrapingTheGuardian</code>()</p>
</blockquote>
<p>A class to represent a scraper from the "Guardian" website.</p>
<p>...</p>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>session : requests_html.HTMLSession
    a web session
VENUE_REGEX : str
    venue regex expression
REFEREE_REGEX : str
    referee regex expression
ODDS_REGEX : str
    odds regex expression</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>calculate_betting_odds(odds)
    returns decimal odds.
extract_preview_items(content,link,preview_date,game_date,game_id,home_team,away_team)
    returns all information of a football preview.
extract_previews(self,page,previews_last_date,last_preview,all_previews,df_teams)
    returns the information of all extracted previews.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Scraping-all-pages">Scraping all pages<a class="anchor-link" href="#Scraping-all-pages"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;scraper.log&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2">:</span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="c1"># starting url</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.theguardian.com/football/series/match-previews&quot;</span>
<span class="c1"># initialize the scraper instance.</span>
<span class="n">scraper</span> <span class="o">=</span> <span class="n">ScrapingTheGuardian</span><span class="p">()</span>
<span class="c1"># initially we are not at the last page.</span>
<span class="n">last_page</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># we&#39;ll extract the previews that haven&#39;t already been extracted.</span>
<span class="n">last_preview</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># we specify the last preview date in the previews collection on which the scraper will be turned off.</span>
<span class="n">mongoengine_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="n">previews_last_date</span> <span class="o">=</span> <span class="n">Previews</span><span class="o">.</span><span class="n">objects</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-previewDate&quot;</span><span class="p">,</span> <span class="s2">&quot;-gameDate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># if the database is empty we will scrap all pages</span>
<span class="k">if</span> <span class="n">previews_last_date</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">last_previews_date</span> <span class="o">=</span> <span class="n">previews_last_date</span><span class="o">.</span><span class="n">previewDate</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">last_previews_date</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The last preview date stored in the database is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_previews_date</span><span class="p">))</span>
<span class="n">all_previews</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># charging teams dictionary</span>
<span class="n">df_teams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;.//datasets//final_data.csv&quot;</span><span class="p">)</span>
<span class="c1"># if we are not at the last page</span>
<span class="c1"># and we haven&#39;t reached an extracted preview</span>
<span class="c1"># we launch the scraper</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">last_page</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">last_preview</span><span class="p">:</span>
    <span class="c1"># a random timer</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The scraper will wait </span><span class="si">{}</span><span class="s2"> seconds ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The scraper will open this url: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="c1"># wait time seconds</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="c1"># get the html format of the page containing previews</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">Parser</span><span class="o">.</span><span class="n">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">scraper</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
    <span class="c1"># launch the scraper , extract previews information</span>
    <span class="n">last_preview</span><span class="p">,</span> <span class="n">all_previews</span> <span class="o">=</span> <span class="n">scraper</span><span class="o">.</span><span class="n">extract_previews</span><span class="p">(</span>
        <span class="n">page</span><span class="p">,</span> <span class="n">last_previews_date</span><span class="p">,</span> <span class="n">last_preview</span><span class="p">,</span> <span class="n">all_previews</span><span class="p">,</span> <span class="n">df_teams</span>
    <span class="p">)</span>
    <span class="c1"># get the url of the following page and verify if we are at the last page</span>
    <span class="n">url</span><span class="p">,</span> <span class="n">last_page</span> <span class="o">=</span> <span class="n">Parser</span><span class="o">.</span><span class="n">get_next_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_previews</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>game_id</th>
      <th>home_team</th>
      <th>away_team</th>
      <th>text</th>
      <th>author</th>
      <th>venue</th>
      <th>referee</th>
      <th>odds</th>
      <th>odds_home_team</th>
      <th>odds_away_team</th>
      <th>odds_draw</th>
      <th>preview_date</th>
      <th>game_date</th>
      <th>preview_link</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>987815</td>
      <td>Huddersfield</td>
      <td>Manchester City</td>
      <td>Most Huddersfield fans were sad to see David W...</td>
      <td>Paul Doyle</td>
      <td>John Smith’s Stadium</td>
      <td>Andre Marriner</td>
      <td>[22-1, 1-6, 8-1]</td>
      <td>23.000000</td>
      <td>1.166667</td>
      <td>9.00</td>
      <td>2019-01-19 09:00:12+00:00</td>
      <td>2019-01-20 13:30:00</td>
      <td>https://www.theguardian.com/football/2019/jan/...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>987818</td>
      <td>Newcastle United</td>
      <td>Cardiff</td>
      <td>There is little love lost between Rafa Benítez...</td>
      <td>Louise Taylor</td>
      <td>St James’ Park</td>
      <td>Stuart Atwell</td>
      <td>[1-1, 10-3, 12-5]</td>
      <td>2.000000</td>
      <td>4.333333</td>
      <td>3.40</td>
      <td>2019-01-18 16:57:35+00:00</td>
      <td>2019-01-19 15:00:00</td>
      <td>https://www.theguardian.com/football/2019/jan/...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>987821</td>
      <td>Wolverhampton Wanderers</td>
      <td>Leicester</td>
      <td>Wolves have lost five of their last seven matc...</td>
      <td>Graham Searles</td>
      <td>Molineux</td>
      <td>Chris Kavanagh</td>
      <td>[6-5, 5-2, 2-1]</td>
      <td>2.200000</td>
      <td>3.500000</td>
      <td>3.00</td>
      <td>2019-01-18 16:19:44+00:00</td>
      <td>2019-01-19 12:30:00</td>
      <td>https://www.theguardian.com/football/2019/jan/...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>987820</td>
      <td>Watford</td>
      <td>Burnley</td>
      <td>Watford and Burnley are unbeaten since Boxing ...</td>
      <td>Graham Searles</td>
      <td>Vicarage Road</td>
      <td>Michael Oliver</td>
      <td>[4-6, 5-1, 3-1]</td>
      <td>1.666667</td>
      <td>6.000000</td>
      <td>4.00</td>
      <td>2019-01-18 15:15:04+00:00</td>
      <td>2019-01-19 15:00:00</td>
      <td>https://www.theguardian.com/football/2019/jan/...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>987817</td>
      <td>Manchester United</td>
      <td>Brighton</td>
      <td>If Manchester United can reel off the seventh ...</td>
      <td>Jamie Jackson</td>
      <td>Old Trafford</td>
      <td>Paul Tierney</td>
      <td>[1-3, 12-1, 5-1]</td>
      <td>1.333333</td>
      <td>13.000000</td>
      <td>6.00</td>
      <td>2019-01-18 14:23:22+00:00</td>
      <td>2019-01-19 15:00:00</td>
      <td>https://www.theguardian.com/football/2019/jan/...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3063</th>
      <td>284023</td>
      <td>Fulham</td>
      <td>Chelsea</td>
      <td>The achievements of Fulham, who came seventh l...</td>
      <td>Kevin McCarra</td>
      <td>Craven Cottage</td>
      <td>A Marriner</td>
      <td>[9-2, 4-7, 5-2]</td>
      <td>5.500000</td>
      <td>1.571429</td>
      <td>3.50</td>
      <td>2009-08-21 21:24:27+00:00</td>
      <td>2009-08-23 15:00:00</td>
      <td>https://www.theguardian.com/football/2009/aug/...</td>
    </tr>
    <tr>
      <th>3064</th>
      <td>284022</td>
      <td>Burnley</td>
      <td>Everton</td>
      <td>Turf Moor thrived on its first top-flight game...</td>
      <td>Andy Hunter</td>
      <td>Turf Moor, Saturday</td>
      <td>P Dowd</td>
      <td>[2-1, 6-5, 11-5]</td>
      <td>3.000000</td>
      <td>2.200000</td>
      <td>3.20</td>
      <td>2009-08-21 21:21:25+00:00</td>
      <td>2009-08-23 14:00:00</td>
      <td>https://www.theguardian.com/football/2009/aug/...</td>
    </tr>
    <tr>
      <th>3065</th>
      <td>284021</td>
      <td>Birmingham City</td>
      <td>Stoke City</td>
      <td>If Birmingham are to stay in the Premier Leagu...</td>
      <td>David Lacey</td>
      <td>St Andrew's, Saturday</td>
      <td>C Foy</td>
      <td>[23-20, 21-10, 11-5]</td>
      <td>2.150000</td>
      <td>3.100000</td>
      <td>3.20</td>
      <td>2009-08-21 21:15:59+00:00</td>
      <td>2009-08-22 14:00:00</td>
      <td>https://www.theguardian.com/football/2009/aug/...</td>
    </tr>
    <tr>
      <th>3066</th>
      <td>284020</td>
      <td>Arsenal</td>
      <td>Portsmouth</td>
      <td>Peter Storrie says he has a mystery new backer...</td>
      <td>David Hytner</td>
      <td>Emirates Stadium, Saturday</td>
      <td>S Bennett</td>
      <td>[1-6, 12-1, 5-1]</td>
      <td>1.166667</td>
      <td>13.000000</td>
      <td>6.00</td>
      <td>2009-08-21 21:13:41+00:00</td>
      <td>2009-08-22 14:00:00</td>
      <td>https://www.theguardian.com/football/2009/aug/...</td>
    </tr>
    <tr>
      <th>3067</th>
      <td>284027</td>
      <td>Sunderland</td>
      <td>Blackburn Rovers</td>
      <td>As a former Newcastle United manager, Blackbur...</td>
      <td>Louise Taylor</td>
      <td>Stadium of Light, Saturday</td>
      <td>A Wiley</td>
      <td>[1-1, 12-5, 9-4]</td>
      <td>2.000000</td>
      <td>3.400000</td>
      <td>3.25</td>
      <td>2009-08-21 21:08:35+00:00</td>
      <td>2009-08-22 14:00:00</td>
      <td>https://www.theguardian.com/football/2009/aug/...</td>
    </tr>
  </tbody>
</table>
<p>3068 rows × 14 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

