---

title: The Guardian Scraper


keywords: fastai
sidebar: home_sidebar

summary: "Scraping Premier League Previews from the Guardian."
description: "Scraping Premier League Previews from the Guardian."
nb_path: "00_scraper.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_scraper.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div style="font-size: 200px">

<table>
<thead><tr>
<th>Issues</th>
<th>Solutions</th>
</tr>
</thead>
<tbody>
<tr>
<td>4 possible formats for previews(old format, new format,Cup's format and a particular format)</td>
<td>Select the appropriate html tags</td>
</tr>
<tr>
<td>Preview titles are not the same ( we can find Squad Sheets or match preview)</td>
<td>Pick only the names of the teams and eliminate the rest</td>
</tr>
<tr>
<td>The date of the match is not always available</td>
<td>Pick the preview date</td>
</tr>
<tr>
<td>The order of the elements and labels are not the same</td>
<td>Using regex patterns to get information</td>
</tr>
<tr>
<td>Missing values for betting odds</td>
<td>We treat the general case separately and we set up specific regex patterns for these particular cases</td>
</tr>
<tr>
<td>Odds format is different</td>
<td>We treat the general case separately and we set up specific regex patterns for these particular cases</td>
</tr>
<tr>
<td>We can find non-numeric values for Odds like (Evens,evens,Eve)</td>
<td>Replace evens by 1-1</td>
</tr>
<tr>
<td>There are some previews that don't have author and text</td>
<td>For previews that have no text, we put None (not available)</td>
</tr>
<tr>
<td>The existence of previews for the FA CUP,Carabao Cup,Champions league,World Cup</td>
<td>Filter previews by title,link,topic,aside html section and preview text and allow only Premier League previews</td>
</tr>
<tr>
<td>We are not sure if the names of the teams are the same as the ones in Opta</td>
<td>Set up a dictionary or check manually to map teams to their IDs</td>
</tr>
<tr>
<td>When we send many requests, the guardian server blocks your IP address, which is interpreted as a DDOS attack</td>
<td>Do a sleep of a random x seconds between requests or change your IP and work with rotating proxy</td>
</tr>
</tbody>
</table>
<p>&lt;/div &gt;</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Import-Libraries-and-Modules">Import Libraries and Modules<a class="anchor-link" href="#Import-Libraries-and-Modules"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ScrapingTheGuardian-Class">ScrapingTheGuardian Class<a class="anchor-link" href="#ScrapingTheGuardian-Class"> </a></h3><h5 id="This-class-represents-a-scraper-from-the-&quot;Guardian&quot;-website-and-has-4-functions:">This class represents a scraper from the "Guardian" website and has 4 functions:<a class="anchor-link" href="#This-class-represents-a-scraper-from-the-&quot;Guardian&quot;-website-and-has-4-functions:"> </a></h5><p>1- <b> calculate_betting_odds </b> returns decimal odds.</p>
<p>&emsp;In this section, we will calculate the odds derived from the football preview.
<br>&emsp;Considering the following example:
<br>&emsp;&emsp; ["9-20","29-5","6-5"] 
<br>&emsp;&emsp;We calculate each sport's rating separately using the following formula:
<br>&emsp;&emsp;&emsp; home = (9/20) + 1 
<br>&emsp;&emsp;&emsp; away = (29/5) + 1
<br>&emsp;&emsp;&emsp; draw = (6/5) + 1
<br>&emsp;If we were successful in obtaining decimal odds, they will be returned in a Python dictionary.<br>&emsp;Otherwise, the values will be None (Not available).</p>
<p>2- <b> extract_preview_items </b>returns the entire contents of a football preview.</p>
<p>&emsp;In this section, we will call the functions defined in the PageExtractor class and return a Python dictionary containing all of this information.
<br>&emsp;But first, we use the <b>calculate_betting_odds</b> function to calculate the sports odds for the home team's victory, the away team's victory, and a draw.</p>
<p>"game Id","home team","away team","text","author","venue","referee","odds","odds home team","odds away team","odds draw", "preview date","game Date","preview_link" are the returned values.</p>
<p>3- <b> extract_previews </b> returns the information of all extracted previews.</p>
<p>&emsp;We retrieve all previews for a given page and go through them one by one, taking the link and getting its data using the "Guardian Api."
<br>&emsp;If the "Guardian Api" does not work, we will resort to the traditional process of html parsing. 
<br>&emsp;For each preview in the data extracted from the Guardian, we will look for the id of the home team and the away team and match it with the <b>opta.fixture</b><br>&emsp;database to get the gameID and gameDate and finally we save it in a MongoDb collection.
<br>&emsp;If the game exists, we will proceed with the data extraction.
The previous function, <b>extract_preview_items</b>, will be called here to extract information from <br>&emsp;each 
preview, which will then be stored in the list "all previews."
<br>&emsp;However, we will only extract previews that do not already exist in the database.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ScrapingTheGuardian" class="doc_header"><code>class</code> <code>ScrapingTheGuardian</code><a href="https://github.com/MeherKharbachi/guardian_scraper/tree/master/guardian_scraper/scraper.py#L23" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ScrapingTheGuardian</code>()</p>
</blockquote>
<p>A class to represent a scraper from the "Guardian" website.</p>
<p>...</p>
<h2 id="Attributes">Attributes<a class="anchor-link" href="#Attributes"> </a></h2><p>session : requests_html.HTMLSession
    a web session
VENUE_REGEX : str
    venue regex expression
REFEREE_REGEX : str
    referee regex expression
ODDS_REGEX : str
    odds regex expression</p>
<h2 id="Methods">Methods<a class="anchor-link" href="#Methods"> </a></h2><p>calculate_betting_odds(odds)
    returns decimal odds.
extract_preview_items(content,link,preview_date,game_date,game_id,home_team,away_team)
    returns all information of a football preview.
extract_previews(self,page,previews_last_date,last_preview,all_previews,df_teams)
    returns the information of all extracted previews.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Scraping-all-pages">Scraping all pages<a class="anchor-link" href="#Scraping-all-pages"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;scraper.log&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2">:</span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="c1"># starting url</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.theguardian.com/football/series/match-previews?page=36&quot;</span>
<span class="c1"># initialize the scraper instance.</span>
<span class="n">scraper</span> <span class="o">=</span> <span class="n">ScrapingTheGuardian</span><span class="p">()</span>
<span class="c1"># initially we are not at the last page.</span>
<span class="n">last_page</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># we&#39;ll extract the previews that haven&#39;t already been extracted.</span>
<span class="n">last_preview</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># we specify the last preview date in the previews collection on which the scraper will be turned off.</span>
<span class="n">mongoengine_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="n">previews_last_date</span> <span class="o">=</span> <span class="n">Previews</span><span class="o">.</span><span class="n">objects</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-previewDate&quot;</span><span class="p">,</span> <span class="s2">&quot;-gameDate&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c1"># if the database is empty we will scrap all pages</span>
<span class="k">if</span> <span class="n">previews_last_date</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">last_previews_date</span> <span class="o">=</span> <span class="n">previews_last_date</span><span class="o">.</span><span class="n">previewDate</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">last_previews_date</span> <span class="o">=</span> <span class="kc">None</span>
    
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The last preview date stored in the database is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_previews_date</span><span class="p">))</span>
<span class="n">all_previews</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># charging teams dictionary</span>
<span class="n">df_teams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;.//datasets//final_data.csv&quot;</span><span class="p">)</span>
<span class="c1"># if we are not at the last page</span>
<span class="c1"># and we haven&#39;t reached an extracted preview</span>
<span class="c1"># we launch the scraper</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">last_page</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">last_preview</span><span class="p">:</span>
    <span class="c1"># a random timer</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The scraper will wait </span><span class="si">{}</span><span class="s2"> seconds ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>
    <span class="c1"># wait time seconds</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="c1"># get the html format of the page containing previews</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">Parser</span><span class="o">.</span><span class="n">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">scraper</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
    <span class="c1"># launch the scraper , extract previews information</span>
    <span class="n">last_preview</span><span class="p">,</span> <span class="n">all_previews</span> <span class="o">=</span> <span class="n">scraper</span><span class="o">.</span><span class="n">extract_previews</span><span class="p">(</span>
        <span class="n">page</span><span class="p">,</span> <span class="n">last_previews_date</span><span class="p">,</span> <span class="n">last_preview</span><span class="p">,</span> <span class="n">all_previews</span><span class="p">,</span> <span class="n">df_teams</span>
    <span class="p">)</span>
    <span class="c1"># get the url of the following page and verify if we are at the last page</span>
    <span class="n">url</span><span class="p">,</span> <span class="n">last_page</span> <span class="o">=</span> <span class="n">Parser</span><span class="o">.</span><span class="n">get_next_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_previews</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>game_id</th>
      <th>home_team</th>
      <th>away_team</th>
      <th>text</th>
      <th>author</th>
      <th>venue</th>
      <th>referee</th>
      <th>odds</th>
      <th>odds_home_team</th>
      <th>odds_away_team</th>
      <th>odds_draw</th>
      <th>preview_date</th>
      <th>game_date</th>
      <th>preview_link</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>987970</td>
      <td>Tottenham</td>
      <td>Everton</td>
      <td>Tottenham are euphoric after Wednesday’s Champ...</td>
      <td>David Hytner</td>
      <td>Tottenham H Stadium</td>
      <td>Andre Marriner</td>
      <td>[5-4, 5-2, 5-2]</td>
      <td>2.250000</td>
      <td>3.500000</td>
      <td>3.500000</td>
      <td>2019-05-10 16:02:57+00:00</td>
      <td>2019-05-12 14:00:00</td>
      <td>https://www.theguardian.com/football/2019/may/...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>987965</td>
      <td>Fulham</td>
      <td>Newcastle</td>
      <td>Scott Parker’s future is no longer in question...</td>
      <td>Benjy Nurick</td>
      <td>Craven Cottage</td>
      <td>Kevin Friend</td>
      <td>[6-4, 7-4, 5-2]</td>
      <td>2.500000</td>
      <td>2.750000</td>
      <td>3.500000</td>
      <td>2019-05-10 15:41:23+00:00</td>
      <td>2019-05-12 14:00:00</td>
      <td>https://www.theguardian.com/football/2019/may/...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>987962</td>
      <td>Brighton</td>
      <td>Manchester City</td>
      <td>Vincent Kompany’s unforgettable winner against...</td>
      <td>Benjy Nurick</td>
      <td>Amex Stadium</td>
      <td>Michael Oliver</td>
      <td>[18-1, 2-11, 8-1]</td>
      <td>19.000000</td>
      <td>1.181818</td>
      <td>9.000000</td>
      <td>2019-05-10 15:26:50+00:00</td>
      <td>2019-05-12 14:00:00</td>
      <td>https://www.theguardian.com/football/2019/may/...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>987963</td>
      <td>Burnley</td>
      <td>Arsenal</td>
      <td>Arsenal will be glad to see the back of their ...</td>
      <td>Graham Searles</td>
      <td>Turf Moor</td>
      <td>Mike Dean</td>
      <td>[23-10, 11-9, 3-1]</td>
      <td>3.300000</td>
      <td>2.222222</td>
      <td>4.000000</td>
      <td>2019-05-10 15:15:24+00:00</td>
      <td>2019-05-12 14:00:00</td>
      <td>https://www.theguardian.com/football/2019/may/...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>987964</td>
      <td>Crystal Palace</td>
      <td>Bournemouth</td>
      <td>After a season of twists and turns, of giddy h...</td>
      <td>Dominic Fifield</td>
      <td>Selhurst Park</td>
      <td>Roger East</td>
      <td>[10-11, 11-4, 3-1]</td>
      <td>1.909091</td>
      <td>3.750000</td>
      <td>4.000000</td>
      <td>2019-05-10 13:52:14+00:00</td>
      <td>2019-05-12 14:00:00</td>
      <td>https://www.theguardian.com/football/2019/may/...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>270</th>
      <td>987636</td>
      <td>Manchester City</td>
      <td>Fulham</td>
      <td>Fulham are the first of the promoted sides to ...</td>
      <td>Jamie Jackson</td>
      <td>Etihad Stadium</td>
      <td>Stuart Atwell</td>
      <td>[1-7, 25-1, 10-1]</td>
      <td>1.142857</td>
      <td>26.000000</td>
      <td>11.000000</td>
      <td>2018-09-14 14:00:55+00:00</td>
      <td>2018-09-15 14:00:00</td>
      <td>https://www.theguardian.com/football/2018/sep/...</td>
    </tr>
    <tr>
      <th>271</th>
      <td>987635</td>
      <td>Huddersfield Town</td>
      <td>Crystal Palace</td>
      <td>Both sides go into the game on the back of dis...</td>
      <td>Paul Doyle</td>
      <td>John Smith’s Stadium</td>
      <td>Graham Scott</td>
      <td>[23-10, 11-5, 27-17]</td>
      <td>3.300000</td>
      <td>3.200000</td>
      <td>2.588235</td>
      <td>2018-09-14 12:35:57+00:00</td>
      <td>2018-09-15 14:00:00</td>
      <td>https://www.theguardian.com/football/2018/sep/...</td>
    </tr>
    <tr>
      <th>272</th>
      <td>987624</td>
      <td>Cardiff City</td>
      <td>Arsenal</td>
      <td>Unai Emery has an excellent chance to record a...</td>
      <td>Graham Searles</td>
      <td>Cardiff City Stadium</td>
      <td>Anthony Taylor</td>
      <td>[9-2, 4-7, 3-1]</td>
      <td>5.500000</td>
      <td>1.571429</td>
      <td>4.000000</td>
      <td>2018-09-01 08:00:48+00:00</td>
      <td>2018-09-02 12:30:00</td>
      <td>https://www.theguardian.com/football/2018/sep/...</td>
    </tr>
    <tr>
      <th>273</th>
      <td>987623</td>
      <td>Burnley</td>
      <td>Manchester United</td>
      <td>Burnley have not made the blistering start the...</td>
      <td>Paul Wilson</td>
      <td>Turf Moor</td>
      <td>Jonathan Moss</td>
      <td>[9-2, 4-6, 13-5]</td>
      <td>5.500000</td>
      <td>1.666667</td>
      <td>3.600000</td>
      <td>2018-09-01 08:00:48+00:00</td>
      <td>2018-09-02 15:00:00</td>
      <td>https://www.theguardian.com/football/2018/sep/...</td>
    </tr>
    <tr>
      <th>274</th>
      <td>987630</td>
      <td>Watford</td>
      <td>Tottenham Hotspur</td>
      <td>Something has to give. Watford and Tottenham e...</td>
      <td>Graham Searles</td>
      <td>Vicarage Road</td>
      <td>Andre Marriner</td>
      <td>[5-1, 7-10, 3-1]</td>
      <td>6.000000</td>
      <td>1.700000</td>
      <td>4.000000</td>
      <td>2018-09-01 07:59:48+00:00</td>
      <td>2018-09-02 15:00:00</td>
      <td>https://www.theguardian.com/football/2018/sep/...</td>
    </tr>
  </tbody>
</table>
<p>275 rows × 14 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;~//previews//dataset//previews.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

